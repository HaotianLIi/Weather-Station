stages:
  - test
  - deploy

test:
  stage: test
  image: php:8.2-cli
  services:
    - postgres:15
  variables:
    DB_CONNECTION: pgsql
    DB_HOST: postgres
    DB_DATABASE: weather_station
    DB_USERNAME: postgres
    DB_PASSWORD: test
  before_script:
    - apt-get update && apt-get install -y unzip libpq-dev postgresql-client
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  script:
    - composer install --no-interaction --prefer-dist
    - php artisan test --no-interaction
  cache:
    paths:
      - vendor/
  only:
    - main
    - develop

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
  script:
    - ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST "
        cd /var/www/weather-station &&
        git pull origin $CI_COMMIT_BRANCH &&
        cp .env.production .env 2>/dev/null || true &&
        composer install --no-dev --optimize-autoloader --no-interaction &&
        php artisan migrate --force &&
        php artisan config:cache &&
        php artisan cache:clear &&
        echo 'Deployment complete!'"
  environment:
    name: production
    url: https://YOUR_DOMAIN_HERE
  only:
    - main
  when: manual
  variables:
    SERVER_USER: ubuntu@laravel-postgres
    SERVER_HOST: 170.75.168.206
